<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易信息分析平台</title>
    <!-- 外部资源引入 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',     // 主色调：蓝色，代表信任和专业
                        secondary: '#36D399',   // 辅助色：绿色，代表上涨和成功
                        danger: '#F87272',      // 警示色：红色，代表下跌和风险
                        warning: '#FBBD23',     // 警告色：黄色，代表注意和提醒
                        dark: '#1E293B',        // 深色：用于文本和主要背景
                        light: '#F8FAFC',       // 浅色：用于次要背景
                        neutral: {
                            100: '#F1F5F9',
                            200: '#E2E8F0',
                            300: '#CBD5E1',
                            400: '#94A3B8',
                            500: '#64748B',
                            600: '#475569',
                            700: '#334155',
                            800: '#1E293B',
                            900: '#0F172A'
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .gradient-bg {
                background: linear-gradient(135deg, #165DFF 0%, #0A2463 100%);
            }
            .text-balance {
                text-wrap: balance;
            }
            .favorite-active {
                color: #FFD700;
                animation: pulse 0.5s ease-in-out;
            }
            .api-connected {
                border-color: #36D399;
                box-shadow: 0 0 0 2px rgba(54, 211, 153, 0.2);
            }
            .slide-up {
                animation: slideUp 0.3s ease-out forwards;
            }
            .fade-in {
                animation: fadeIn 0.3s ease-out forwards;
            }
            @keyframes slideUp {
                from { transform: translateY(100%); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.3); }
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="gradient-bg text-white shadow-md z-50 sticky top-0 transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fa fa-line-chart text-2xl"></i>
                <h1 class="text-xl font-bold">交易信息分析平台</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="refresh-btn" class="p-2 rounded-full hover:bg-white/20 transition-all relative">
                    <i class="fa fa-refresh"></i>
                    <span id="refresh-badge" class="absolute -top-1 -right-1 bg-danger text-white text-xs w-4 h-4 flex items-center justify-center rounded-full hidden">
                        !
                    </span>
                </button>
                <button id="settings-btn" class="p-2 rounded-full hover:bg-white/20 transition-all">
                    <i class="fa fa-cog"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- API配置模态框 -->
    <div id="api-config-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 transform transition-all scale-95 opacity-0" id="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">交易平台API配置</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="api-config-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">平台名称</label>
                        <select id="api-platform" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <option value="demo">Demo平台</option>
                            <option value="xueqiu">雪球API</option>
                            <option value="eastmoney">东方财富API</option>
                            <option value="custom">自定义API</option>
                        </select>
                    </div>
                    
                    <div id="api-key-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                        <input type="text" id="api-key" placeholder="请输入API Key" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    
                    <div id="api-secret-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Secret</label>
                        <input type="password" id="api-secret" placeholder="请输入API Secret" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    
                    <div id="api-url-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">API URL</label>
                        <input type="text" id="api-url" placeholder="请输入API基础URL" value="https://api.example.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-config" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center justify-center">
                        <i class="fa fa-save mr-2"></i> 保存配置
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 交易操作模态框 -->
    <div id="trade-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 transform transition-all scale-95 opacity-0" id="trade-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold" id="trade-stock-name">交易操作</h3>
                <button id="close-trade-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="trade-form">
                <input type="hidden" id="trade-stock-code">
                
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <button type="button" class="trade-type-btn px-4 py-2 bg-primary text-white rounded-lg flex items-center justify-center" data-type="buy">
                            <i class="fa fa-shopping-cart mr-2"></i> 买入
                        </button>
                        <button type="button" class="trade-type-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg flex items-center justify-center" data-type="sell">
                            <i class="fa fa-exchange mr-2"></i> 卖出
                        </button>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">交易价格</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">¥</span>
                            <input type="number" id="trade-price" placeholder="请输入交易价格" step="0.01" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">交易数量</label>
                        <input type="number" id="trade-amount" placeholder="请输入交易数量" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">交易类型</label>
                        <select id="trade-method" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <option value="limit">限价交易</option>
                            <option value="market">市价交易</option>
                            <option value="stop">止损交易</option>
                        </select>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-xs text-gray-600">
                            <i class="fa fa-info-circle mr-1"></i> 交易费用：买入/卖出均收取0.03%的手续费，印花税0.1%（卖出时收取）
                        </p>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button type="submit" id="submit-trade" class="w-full py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center justify-center">
                        <i class="fa fa-check mr-2"></i> 确认买入
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 加载中提示 -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/30 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-6 flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-primary/30 border-t-primary rounded-full animate-spin mb-4"></div>
            <p id="loading-text" class="font-medium">加载中...</p>
        </div>
    </div>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6">
        <!-- API连接状态 -->
        <div id="api-status" class="mb-4 p-3 rounded-lg flex items-center justify-between bg-white card-shadow transition-all duration-300">
            <div class="flex items-center">
                <div id="api-status-icon" class="w-3 h-3 rounded-full bg-gray-300 mr-2 transition-colors"></div>
                <span id="api-status-text">未连接交易平台</span>
            </div>
            <button id="connect-api" class="text-primary text-sm hover:underline flex items-center">
                <i class="fa fa-plug mr-1"></i> 连接平台
            </button>
        </div>

        <!-- 筛选和搜索 -->
        <div class="mb-6 bg-white rounded-xl p-4 card-shadow">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500">排序方式:</span>
                    <select id="sort-select" class="bg-gray-100 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <option value="90-concentration">90%筹码集中度</option>
                        <option value="70-concentration">70%筹码集中度</option>
                        <option value="price-diff">价格偏离度</option>
                        <option value="price-change">涨跌幅</option>
                    </select>
                </div>
                <div class="relative">
                    <input type="text" id="search-input" placeholder="搜索代码/名称..." 
                           class="w-full md:w-64 pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
        </div>

        <!-- 自选股标签页 -->
        <div class="mb-6 bg-white rounded-xl overflow-hidden card-shadow">
            <div class="flex border-b border-gray-100">
                <button id="all-stocks-tab" class="flex-1 py-3 font-medium text-primary border-b-2 border-primary">全部</button>
                <button id="favorites-tab" class="flex-1 py-3 font-medium text-gray-500">自选</button>
            </div>
            <div id="favorites-empty" class="py-8 text-center text-gray-400 hidden">
                <i class="fa fa-star-o text-4xl mb-3"></i>
                <p>暂无自选股票</p>
                <p class="text-xs mt-2">点击股票卡片上的⭐添加自选</p>
            </div>
            <div id="favorites-list" class="p-4 space-y-3 max-h-[200px] overflow-y-auto scrollbar-hide">
                <!-- 自选股将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 股票列表 -->
        <div class="space-y-4 mb-8">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-semibold">股票列表</h2>
                <div class="flex items-center space-x-2">
                    <span id="stock-count" class="text-xs bg-primary/10 text-primary px-3 py-1 rounded-full">0 只股票</span>
                    <div class="relative">
                        <button id="filter-btn" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full flex items-center">
                            <i class="fa fa-filter mr-1"></i> 筛选
                        </button>
                        <div id="filter-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 hidden z-10">
                            <div class="px-4 py-2 text-sm text-gray-700">价格区间</div>
                            <div class="px-4 py-2 flex items-center">
                                <input type="number" placeholder="最低" class="w-1/2 px-2 py-1 border border-gray-300 rounded text-xs mr-2">
                                <input type="number" placeholder="最高" class="w-1/2 px-2 py-1 border border-gray-300 rounded text-xs">
                            </div>
                            <div class="px-4 py-2 text-sm text-gray-700">涨跌幅</div>
                            <div class="px-4 py-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2"> 上涨
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2"> 下跌
                                </label>
                            </div>
                            <div class="px-4 py-2 border-t border-gray-100">
                                <button class="w-full py-1 bg-primary text-white rounded text-xs">应用筛选</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="stock-list" class="space-y-3 max-h-[calc(100vh-500px)] overflow-y-auto scrollbar-hide">
                <!-- 股票项将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 详情卡片 -->
        <div id="detail-card" class="bg-white rounded-xl overflow-hidden card-shadow mb-8 opacity-0 transition-opacity duration-300">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <div>
                    <h3 id="detail-name" class="text-xl font-bold"></h3>
                    <p id="detail-code" class="text-sm text-gray-500"></p>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-right">
                        <p id="detail-price" class="text-2xl font-bold"></p>
                        <p id="detail-change" class="text-sm"></p>
                    </div>
                    <button id="detail-favorite-btn" class="p-2 rounded-full hover:bg-gray-100 transition-all">
                        <i class="fa fa-star-o text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-4 border-b border-gray-100">
                <div class="text-center">
                    <p class="text-xs text-gray-500">120日均价</p>
                    <p id="detail-avg-price" class="font-semibold"></p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500">120日最低</p>
                    <p id="detail-min-price" class="font-semibold"></p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500">90%筹码</p>
                    <p id="detail-90-concentration" class="font-semibold"></p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500">70%筹码</p>
                    <p id="detail-70-concentration" class="font-semibold"></p>
                </div>
            </div>
            
            <div class="p-4">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-medium">120日价格走势</h4>
                    <div class="flex space-x-2">
                        <button class="period-btn px-3 py-1 text-xs rounded-full bg-primary/10 text-primary">日K</button>
                        <button class="period-btn px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-500">周K</button>
                        <button class="period-btn px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-500">月K</button>
                    </div>
                </div>
                <div class="h-64">
                    <canvas id="price-chart"></canvas>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-100">
                <h4 class="font-medium mb-4">筹码分布图</h4>
                <div class="h-64">
                    <canvas id="chip-chart"></canvas>
                </div>
            </div>
            
            <!-- 交易操作按钮 -->
            <div class="p-4 border-t border-gray-100">
                <div class="grid grid-cols-2 gap-4">
                    <button id="buy-btn" class="py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-colors flex items-center justify-center">
                        <i class="fa fa-shopping-cart mr-2"></i> 买入
                    </button>
                    <button id="sell-btn" class="py-2 bg-danger text-white rounded-lg hover:bg-danger/90 transition-colors flex items-center justify-center">
                        <i class="fa fa-exchange mr-2"></i> 卖出
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 底部导航 -->
    <footer class="bg-white border-t border-gray-200 py-2 px-4 sticky bottom-0">
        <div class="flex justify-around">
            <button class="flex flex-col items-center text-primary">
                <i class="fa fa-home text-xl mb-1"></i>
                <span class="text-xs">首页</span>
            </button>
            <button class="flex flex-col items-center text-gray-400 hover:text-primary transition-colors">
                <i class="fa fa-compass text-xl mb-1"></i>
                <span class="text-xs">发现</span>
            </button>
            <button class="flex flex-col items-center text-gray-400 hover:text-primary transition-colors">
                <i class="fa fa-star-o text-xl mb-1"></i>
                <span class="text-xs">收藏</span>
            </button>
            <button class="flex flex-col items-center text-gray-400 hover:text-primary transition-colors">
                <i class="fa fa-user-o text-xl mb-1"></i>
                <span class="text-xs">我的</span>
            </button>
        </div>
    </footer>

    <!-- 交易结果提示 -->
    <div id="trade-toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-dark text-white px-4 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 flex items-center z-50">
        <i id="toast-icon" class="fa fa-check-circle mr-2"></i>
        <span id="toast-message">交易成功</span>
    </div>

    <script>
        // 应用状态管理
        const AppState = {
            // 股票数据
            stocks: [
                {
                    code: "000001",
                    name: "平安银行",
                    price: 15.62,
                    change: 0.32,
                    changePercent: 2.09,
                    avgPrice120: 14.87,
                    minPrice120: 13.25,
                    concentration90: 0.15,  // 90%筹码集中度
                    concentration70: 0.08,  // 70%筹码集中度
                    priceHistory: generateRandomPrices(120, 13, 17),  // 120日价格历史
                    chipDistribution: generateChipDistribution(),  // 筹码分布数据
                    favorite: false,  // 是否为自选股
                    market: "SZ"  // 市场标识
                },
                {
                    code: "000002",
                    name: "万科A",
                    price: 24.85,
                    change: -0.45,
                    changePercent: -1.78,
                    avgPrice120: 26.31,
                    minPrice120: 23.58,
                    concentration90: 0.18,
                    concentration70: 0.10,
                    priceHistory: generateRandomPrices(120, 23, 28),
                    chipDistribution: generateChipDistribution(),
                    favorite: true,
                    market: "SZ"
                },
                {
                    code: "000004",
                    name: "国华网安",
                    price: 10.36,
                    change: 0.52,
                    changePercent: 5.27,
                    avgPrice120: 9.85,
                    minPrice120: 7.62,
                    concentration90: 0.12,
                    concentration70: 0.05,
                    priceHistory: generateRandomPrices(120, 7, 11),
                    chipDistribution: generateChipDistribution(),
                    favorite: false,
                    market: "SZ"
                },
                {
                    code: "000005",
                    name: "世纪星源",
                    price: 3.82,
                    change: -0.05,
                    changePercent: -1.29,
                    avgPrice120: 3.65,
                    minPrice120: 3.12,
                    concentration90: 0.22,
                    concentration70: 0.13,
                    priceHistory: generateRandomPrices(120, 3, 4),
                    chipDistribution: generateChipDistribution(),
                    favorite: true,
                    market: "SZ"
                },
                {
                    code: "000006",
                    name: "深振业A",
                    price: 5.73,
                    change: 0.12,
                    changePercent: 2.14,
                    avgPrice120: 5.58,
                    minPrice120: 4.87,
                    concentration90: 0.16,
                    concentration70: 0.09,
                    priceHistory: generateRandomPrices(120, 4.5, 6),
                    chipDistribution: generateChipDistribution(),
                    favorite: false,
                    market: "SZ"
                },
                {
                    code: "600000",
                    name: "浦发银行",
                    price: 8.95,
                    change: 0.05,
                    changePercent: 0.56,
                    avgPrice120: 9.12,
                    minPrice120: 8.54,
                    concentration90: 0.14,
                    concentration70: 0.07,
                    priceHistory: generateRandomPrices(120, 8, 10),
                    chipDistribution: generateChipDistribution(),
                    favorite: false,
                    market: "SH"
                },
                {
                    code: "600004",
                    name: "白云机场",
                    price: 13.28,
                    change: -0.12,
                    changePercent: -0.9,
                    avgPrice120: 13.87,
                    minPrice120: 12.45,
                    concentration90: 0.17,
                    concentration70: 0.09,
                    priceHistory: generateRandomPrices(120, 12, 15),
                    chipDistribution: generateChipDistribution(),
                    favorite: false,
                    market: "SH"
                },
                {
                    code: "600006",
                    name: "东风汽车",
                    price: 5.24,
                    change: 0.11,
                    changePercent: 2.14,
                    avgPrice120: 4.98,
                    minPrice120: 4.32,
                    concentration90: 0.13,
                    concentration70: 0.06,
                    priceHistory: generateRandomPrices(120, 4, 6),
                    chipDistribution: generateChipDistribution(),
                    favorite: false,
                    market: "SH"
                }
            ],
            
            // API配置
            apiConfig: {
                platform: 'demo',
                key: '',
                secret: '',
                url: 'https://api.example.com',
                connected: false
            },
            
            // 当前选中的股票
            selectedStock: null,
            
            // 当前交易类型
            currentTradeType: 'buy',
            
            // 图表实例
            priceChart: null,
            chipChart: null,
            
            // 初始化应用
            init() {
                this.loadApiConfig();
                this.updateApiStatus();
                this.renderStockList(this.stocks);
                this.initEventListeners();
                this.updateFavorites();
                document.getElementById('stock-count').textContent = `${this.stocks.length} 只股票`;
            },
            
            // 初始化事件监听器
            initEventListeners() {
                // 刷新按钮事件
                document.getElementById('refresh-btn').addEventListener('click', () => {
                    this.showLoading('数据刷新中...');
                    this.fetchStockData().then(() => {
                        this.hideLoading();
                        this.renderStockList(this.stocks);
                        this.showToast('数据刷新成功', 'success');
                    }).catch(() => {
                        this.hideLoading();
                        this.showToast('数据刷新失败', 'error');
                    });
                });
                
                // 排序选择事件
                document.getElementById('sort-select').addEventListener('change', (e) => {
                    this.sortStocks(e.target.value);
                });
                
                // 搜索事件
                document.getElementById('search-input').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredStocks = this.stocks.filter(stock => 
                        stock.code.toLowerCase().includes(searchTerm) || 
                        stock.name.toLowerCase().includes(searchTerm)
                    );
                    this.renderStockList(filteredStocks);
                });
                
                // 周期按钮事件
                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.period-btn').forEach(b => {
                            b.classList.remove('bg-primary/10', 'text-primary');
                            b.classList.add('bg-gray-100', 'text-gray-500');
                        });
                        e.target.classList.remove('bg-gray-100', 'text-gray-500');
                        e.target.classList.add('bg-primary/10', 'text-primary');
                        
                        // 更新图表周期
                        this.updateChartPeriod(e.target.textContent);
                    });
                });
                
                // 自选股标签页切换
                document.getElementById('all-stocks-tab').addEventListener('click', () => {
                    this.showAllStocks();
                });
                
                document.getElementById('favorites-tab').addEventListener('click', () => {
                    this.showFavorites();
                });
                
                // API配置按钮事件
                document.getElementById('connect-api').addEventListener('click', () => {
                    this.openApiConfigModal();
                });
                
                document.getElementById('settings-btn').addEventListener('click', () => {
                    this.openApiConfigModal();
                });
                
                // 关闭API配置模态框
                document.getElementById('close-modal').addEventListener('click', () => {
                    this.closeApiConfigModal();
                });
                
                document.getElementById('cancel-config').addEventListener('click', () => {
                    this.closeApiConfigModal();
                });
                
                // 保存API配置
                document.getElementById('api-config-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveApiConfig();
                    this.closeApiConfigModal();
                    this.updateApiStatus();
                    this.showToast('API配置已保存', 'success');
                });
                
                // 交易操作按钮事件
                document.getElementById('buy-btn').addEventListener('click', () => {
                    if (!this.apiConfig.connected) {
                        this.showToast('请先连接交易平台', 'warning');
                        this.openApiConfigModal();
                        return;
                    }
                    
                    if (!this.selectedStock) return;
                    
                    this.openTradeModal('buy');
                });
                
                document.getElementById('sell-btn').addEventListener('click', () => {
                    if (!this.apiConfig.connected) {
                        this.showToast('请先连接交易平台', 'warning');
                        this.openApiConfigModal();
                        return;
                    }
                    
                    if (!this.selectedStock) return;
                    
                    this.openTradeModal('sell');
                });
                
                // 交易类型切换
                document.querySelectorAll('.trade-type-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.currentTradeType = e.target.dataset.type;
                        
                        document.querySelectorAll('.trade-type-btn').forEach(b => {
                            b.classList.remove('bg-primary', 'text-white');
                            b.classList.add('bg-gray-200', 'text-gray-700');
                        });
                        
                        e.target.classList.remove('bg-gray-200', 'text-gray-700');
                        e.target.classList.add('bg-primary', 'text-white');
                        
                        // 更新按钮文本
                        const submitBtn = document.getElementById('submit-trade');
                        submitBtn.innerHTML = this.currentTradeType === 'buy' 
                            ? '<i class="fa fa-shopping-cart mr-2"></i> 确认买入' 
                            : '<i class="fa fa-exchange mr-2"></i> 确认卖出';
                    });
                });
                
                // 提交交易
                document.getElementById('trade-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitTrade();
                });
                
                // 关闭交易模态框
                document.getElementById('close-trade-modal').addEventListener('click', () => {
                    this.closeTradeModal();
                });
                
                // 筛选下拉菜单
                document.getElementById('filter-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const dropdown = document.getElementById('filter-dropdown');
                    dropdown.classList.toggle('hidden');
                });
                
                // 点击其他区域关闭下拉菜单
                document.addEventListener('click', () => {
                    document.getElementById('filter-dropdown').classList.add('hidden');
                });
                
                // 监听滚动事件，改变导航栏样式
                window.addEventListener('scroll', () => {
                    const header = document.querySelector('header');
                    if (window.scrollY > 10) {
                        header.classList.add('py-2');
                        header.classList.remove('py-3');
                    } else {
                        header.classList.add('py-3');
                        header.classList.remove('py-2');
                    }
                });
                
                // 监听存储变化事件
                window.addEventListener('storage', (e) => {
                    if (e.key === 'favorites') {
                        this.updateFavorites();
                    }
                });
            },
            
            // 从API获取股票数据
            async fetchStockData() {
                // 如果没有连接API，使用模拟数据
                if (!this.apiConfig.connected || this.apiConfig.platform === 'demo') {
                    // 模拟数据更新
                    return new Promise(resolve => setTimeout(() => {
                        // 随机更新部分股票价格
                        this.stocks.forEach(stock => {
                            const change = (Math.random() - 0.5) * 0.2;
                            stock.change = change.toFixed(2);
                            stock.price = (parseFloat(stock.price) + parseFloat(change)).toFixed(2);
                            stock.changePercent = ((parseFloat(change) / (parseFloat(stock.price) - parseFloat(change))) * 100).toFixed(2);
                        });
                        
                        // 如果有选中的股票，更新其数据
                        if (this.selectedStock) {
                            const updatedStock = this.stocks.find(s => s.code === this.selectedStock.code);
                            if (updatedStock) {
                                this.selectedStock = updatedStock;
                                this.renderStockDetail(this.selectedStock);
                            }
                        }
                        
                        resolve();
                    }, 800));
                }
                
                // 实际应用中这里应该调用真实的API
                try {
                    // 模拟API请求
                    return new Promise(resolve => setTimeout(resolve, 800));
                } catch (error) {
                    console.error('获取股票数据失败:', error);
                    throw error;
                }
            },
            
            // 渲染股票列表
            renderStockList(stocks) {
                const stockListEl = document.getElementById('stock-list');
                stockListEl.innerHTML = '';
                
                if (stocks.length === 0) {
                    stockListEl.innerHTML = `
                        <div class="flex items-center justify-center h-24 text-gray-400">
                            <i class="fa fa-search-minus mr-2"></i> 没有找到匹配的股票
                        </div>
                    `;
                    return;
                }
                
                stocks.forEach(stock => {
                    const stockItem = document.createElement('div');
                    stockItem.className = 'bg-white rounded-xl p-4 card-shadow hover:shadow-lg transition-all duration-300 cursor-pointer transform hover:-translate-y-1';
                    stockItem.dataset.code = stock.code;
                    
                    // 计算价格与120日最低价格的关系
                    const priceDiff = parseFloat(stock.price) - (parseFloat(stock.minPrice120) - parseFloat(stock.minPrice120) * stock.concentration90);
                    const diffPercent = ((priceDiff / parseFloat(stock.price)) * 100).toFixed(2);
                    
                    // 计算价格与筹码分布的关系
                    const pricePosition = ((parseFloat(stock.price) - parseFloat(stock.minPrice120)) / 
                                          (parseFloat(stock.avgPrice120) * 1.5 - parseFloat(stock.minPrice120))) * 100;
                    const pricePositionClamped = Math.max(0, Math.min(100, pricePosition));
                    
                    stockItem.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${stock.name}</h3>
                                <p class="text-xs text-gray-500">${stock.code} · ${stock.market}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="text-right">
                                    <p class="text-lg font-bold ${parseFloat(stock.change) >= 0 ? 'text-danger' : 'text-secondary'}">${stock.price}</p>
                                    <p class="text-xs ${parseFloat(stock.change) >= 0 ? 'text-danger' : 'text-secondary'}">
                                        ${parseFloat(stock.change) >= 0 ? '+' : ''}${stock.change} (${parseFloat(stock.changePercent) >= 0 ? '+' : ''}${stock.changePercent}%)
                                    </p>
                                </div>
                                <button class="favorite-btn p-2 rounded-full hover:bg-gray-100 transition-all" data-code="${stock.code}">
                                    <i class="fa fa-star-o text-xl ${stock.favorite ? 'text-yellow-400 favorite-active' : ''}"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-3 grid grid-cols-3 gap-2 text-center">
                            <div>
                                <p class="text-xs text-gray-500">120日均价</p>
                                <p class="text-sm">${stock.avgPrice120}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">90%筹码</p>
                                <p class="text-sm">${(stock.concentration90 * 100).toFixed(1)}%</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">偏离度</p>
                                <p class="text-sm ${priceDiff >= 0 ? 'text-danger' : 'text-secondary'}">${priceDiff >= 0 ? '+' : ''}${diffPercent}%</p>
                            </div>
                        </div>
                        <div class="mt-3 h-2 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full ${parseFloat(stock.change) >= 0 ? 'bg-danger' : 'bg-secondary'}" style="width: ${Math.abs(parseFloat(stock.changePercent))}%"></div>
                        </div>
                        <div class="mt-2 flex justify-between items-center text-xs text-gray-500">
                            <span>价格位置: ${pricePositionClamped.toFixed(0)}%</span>
                            <span>成交量: 12.5万手</span>
                        </div>
                    `;
                    
                    stockItem.addEventListener('click', () => {
                        this.showStockDetail(stock);
                    });
                    
                    // 添加收藏按钮事件
                    const favoriteBtn = stockItem.querySelector('.favorite-btn');
                    favoriteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleFavorite(stock.code);
                    });
                    
                    stockListEl.appendChild(stockItem);
                });
            },
            
            // 显示股票详情
            showStockDetail(stock) {
                this.selectedStock = stock;
                const detailCard = document.getElementById('detail-card');
                detailCard.classList.remove('opacity-0');
                
                // 填充详情数据
                document.getElementById('detail-name').textContent = stock.name;
                document.getElementById('detail-code').textContent = `${stock.code} · ${stock.market}`;
                document.getElementById('detail-price').textContent = stock.price;
                document.getElementById('detail-price').className = `text-2xl font-bold ${parseFloat(stock.change) >= 0 ? 'text-danger' : 'text-secondary'}`;
                document.getElementById('detail-change').textContent = 
                    `${parseFloat(stock.change) >= 0 ? '+' : ''}${stock.change} (${parseFloat(stock.changePercent) >= 0 ? '+' : ''}${stock.changePercent}%)`;
                document.getElementById('detail-change').className = `text-sm ${parseFloat(stock.change) >= 0 ? 'text-danger' : 'text-secondary'}`;
                document.getElementById('detail-avg-price').textContent = stock.avgPrice120;
                document.getElementById('detail-min-price').textContent = stock.minPrice120;
                document.getElementById('detail-90-concentration').textContent = `${(stock.concentration90 * 100).toFixed(1)}%`;
                document.getElementById('detail-70
